# Migration folder

This folder contains the Truffle migration files. The file `2_interledger_setup.js` is a script to deploy the smart contracts and set them up in a condition that is possible to test Interledger. Namely, the script creates the required Authority and Vendor contracts, creates a product, and a vulnerability submission that is approved and acknowledged. The script has also the goal to show the flow of calls.

To differentiate two testing conditions, the patch from the Vendor and the grace period, the configuration file `../truffle-config.js` exposes two aliases of the same network: this allows the `2_interledger_setup.js` to setup a smaller or bigger timelock.

The following guide explains how to work with a local testing network, like ganache-cli.

## Setup
Run [ganache-cli](https://github.com/trufflesuite/ganache-cli) at port 7545. If you encounter an error like *"Error: The network id specified in the truffle config (5777) does not match the one returned by the network (1606900697560)"*, include also the network id 5777.

    ganache-cli -p 7545 -i 5777

## Run script

Running the `2_interledger_setup.js` will print con console all the data, accounts and smart contract addresses.

As said, there are two network aliases to run the script.

### 1st condition: Patched by the vendor

Run the script with the following Truffle command:

    truffle migrate --network to_patch --reset

(--reset is required to force Truffle to run the script a second time and so on). In this case, the timelock to patch a vulnerability is set to 100000 seconds. Therefore the Vendor has the time required to provide a patch, and test the condition that is the Vendor calling the smart contract with the secret, and thus triggering Interledger.

**Note: if --network net_name is omitted, truffle executes a default network called "development". In that case, the timelock is set to 100000 seconds.**

### 2nd condition: Grace period exipres

Run the script with the following Truffle command:

    truffle migrate --network to_grace_period --reset

In this case, the timelock to patch a vulnerability is set to 10 seconds. So it is possible to test the condition that the Expert, or the Authority, can trigger the disclosure procedure by revealing the secret. NOTE: the Vendor can also trigger the disclosure procedure, but an event will notify that the grace period has expired.


## Publish the secret

To publish the secret, thus triggering the disclosure procedure, is required to call the `publishSecret` function of the Auhtority smart contract. Depending on the caller and on the condition (to patch, or grace period expired), the function will emit events with different parameters. To call the function is possible to include **one of** the following lines at the bottom of  `2_interledger_setup.js` (so executing the script will trigger Interledger):

```javascript
await authorityC.publishSecret(vulnerabilityId, secret, {from: expert});
// or
await authorityC.publishSecret(vulnerabilityId, secret, {from: vendor});
```

Or via Truffle console (after running the script), but in this case is required to retrieve all the variables (like contract instancea and addresses). For example:

    truffle console --network to_patch //recall, to_patch or to_grace_period are aliases//

    console)> const expert = "expert address (printed by script)"
    console)> const secret = 123
    console)> const authorityC = await AuthorityContract.deployed()
    console)> await authorityC.publishSecret(vulnerabilityId, secret, {from: expert})

## Note

The accounts of Expert, Authority, Vendor and Interledger are picked from those generated by ganache-cli. If any of those should have a predefined account or address, remeber to substitute the following fields in the script:

```javascript
let authority = accounts[0];
let expert = accounts[1];
let vendor = accounts[2];
let interledger = accounts[3];
```

Or, alternatively, include in the scripts the code to read them from a configuration file, if any.

## References

These steps follow the Truffle tool. Truffle provides a wrapper library of web3js called **truffle-contract** that simplifies the syntax and allows methods like `.at()` and `deployed()`.


truffle-contract library [documentation](https://www.npmjs.com/package/@truffle/contract);

truffle migration scripts [documentation](https://www.trufflesuite.com/docs/truffle/getting-started/running-migrations);

truffle console [documentation](https://www.trufflesuite.com/docs/truffle/getting-started/using-truffle-develop-and-the-console);